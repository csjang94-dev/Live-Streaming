# AWS 라이브 스트리밍 구현 가이드

## Phase 1: 사전 준비

### 1.1 AWS 계정 설정

필요한 권한:
- MediaLive Full Access
- MediaPackage Full Access
- CloudFront Full Access
- S3 Full Access
- CloudWatch Logs
- IAM Role 생성 권한

### 1.2 리전 선택

권장 리전: ap-northeast-2 (서울)
- 낮은 레이턴시
- 모든 Media Services 지원
- 국내 사용자 대상 최적화

### 1.3 필수 도구

- AWS CLI 설치 및 구성
- Larix Broadcaster 앱 (iOS/Android)
- 테스트용 비디오 플레이어 (VLC, HLS.js 등)

## Phase 2: IAM 역할 생성

### 2.1 MediaLive Access Role

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "Service": "medialive.amazonaws.com"
      },
      "Action": "sts:AssumeRole"
    }
  ]
}
```

권한 정책:
- AmazonSSMReadOnlyAccess
- MediaPackage 쓰기 권한
- S3 쓰기 권한
- CloudWatch Logs 쓰기 권한

### 2.2 S3 Bucket Policy

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "MediaLiveAccess",
      "Effect": "Allow",
      "Principal": {
        "Service": "medialive.amazonaws.com"
      },
      "Action": [
        "s3:PutObject",
        "s3:PutObjectAcl"
      ],
      "Resource": "arn:aws:s3:::your-bucket-name/*"
    }
  ]
}
```

## Phase 3: MediaPackage 설정

### 3.1 채널 생성

AWS Console → MediaPackage → Channels → Create

설정 값:
- ID: live-stream-channel
- Description: Live streaming channel for mobile broadcast
- Input Type: HLS

생성 완료 후 받는 정보:
- Channel ARN
- HLS Ingest URL (Primary)
- HLS Ingest URL (Secondary)
- Username
- Password

### 3.2 Endpoint 생성

Endpoint 1: HLS Endpoint
- ID: hls-endpoint
- Manifest Name: index.m3u8
- Segment Duration: 6초
- Playlist Window: 60초
- Time Delay: 30초

Endpoint 2: DASH Endpoint (선택)
- ID: dash-endpoint
- Manifest Name: index.mpd
- Segment Duration: 6초

### 3.3 ABR 스트림 설정

Manifest Configuration:
- Stream 1: 1080p (5000 kbps)
- Stream 2: 720p (3000 kbps)
- Stream 3: 480p (1500 kbps)
- Stream 4: 360p (800 kbps)

## Phase 4: MediaLive 채널 생성

### 4.1 Input 생성

AWS Console → MediaLive → Inputs → Create

Input Type: RTMP Push
- Name: mobile-rtmp-input
- Type: Standard (Single Pipeline 또는 Redundant Pipeline)
- Input Security Group: 새로 생성
  - Whitelist Rule: 0.0.0.0/0 (테스트용, 프로덕션에서는 특정 IP로 제한)

생성 완료 후:
- Primary Endpoint URL: rtmp://xxx.xxx.xxx.xxx:1935/live/stream-key-1
- Secondary Endpoint URL: rtmp://yyy.yyy.yyy.yyy:1935/live/stream-key-2

### 4.2 채널 생성

Channel Configuration:
- Name: live-streaming-channel
- IAM Role: MediaLive Access Role 선택

Input Attachments:
- Input: mobile-rtmp-input 선택

### 4.3 Output Groups 설정

**Output Group 1: MediaPackage**

Settings:
- MediaPackage Group Settings
  - Destination: MediaPackage Channel ID 입력
- H.264 Video Settings:
  - Codec: H.264
  - Rate Control: CBR
  - Bitrate: 5000000 (5 Mbps)
  - Frame Rate: 30 fps
  - Resolution: 1920x1080
  - Profile: High
  - Level: 4.1
- AAC Audio Settings:
  - Codec: AAC
  - Bitrate: 128000 (128 kbps)
  - Sample Rate: 48000 Hz
  - Coding Mode: Stereo

**Output Group 2: Archive (S3)**

Settings:
- Archive Group Settings
  - Destination: s3://your-bucket-name/live-archive/
  - Rollover Interval: 3600초 (1시간)
- Container: MPEG-TS
- Video와 Audio는 위와 동일

### 4.4 ABR 레더 생성

추가 Output 생성:
- Output 2: 720p @ 3 Mbps
- Output 3: 480p @ 1.5 Mbps
- Output 4: 360p @ 800 Kbps

각 Output의 Video Encode 설정만 다르게:
- Width/Height 조정
- Bitrate 조정
- 나머지는 동일

## Phase 5: CloudFront Distribution 생성

### 5.1 Distribution 생성

AWS Console → CloudFront → Create Distribution

Origin Settings:
- Origin Domain: MediaPackage Endpoint URL (도메인 부분만)
- Origin Path: /out/v1/{endpoint-id}
- Origin Protocol Policy: HTTPS Only
- Origin Custom Headers:
  - X-MediaPackage-CDNIdentifier: CloudFront Distribution ID

Default Cache Behavior:
- Viewer Protocol Policy: Redirect HTTP to HTTPS
- Allowed HTTP Methods: GET, HEAD, OPTIONS
- Cache Policy: CachingOptimized
- Origin Request Policy: CORS-CustomOrigin

Additional Settings:
- Price Class: Use All Edge Locations
- Alternate Domain Names (CNAMEs): your-domain.com (선택)
- SSL Certificate: Default CloudFront Certificate

### 5.2 Cache Behaviors 추가

Behavior for *.m3u8:
- Path Pattern: *.m3u8
- TTL: Min 1, Max 5, Default 2

Behavior for *.ts:
- Path Pattern: *.ts
- TTL: Min 60, Max 86400, Default 3600

## Phase 6: Larix Broadcaster 설정

### 6.1 앱에서 연결 설정

Settings → Connections → Add Connection

Connection Type: RTMP
- Name: AWS Live Stream
- URL: MediaLive Primary Endpoint URL 입력
  예: rtmp://12.34.56.78:1935/live/stream-key-1

Video Settings:
- Resolution: 1920x1080
- Frame Rate: 30 fps
- Bitrate: 5000 kbps
- Keyframe Interval: 2초

Audio Settings:
- Sample Rate: 48000 Hz
- Bitrate: 128 kbps
- Channels: Stereo

### 6.2 스트리밍 시작

1. MediaLive 채널 시작 (콘솔에서 Start)
2. Larix Broadcaster에서 연결 선택
3. Start Broadcast 버튼 클릭
4. 스트림 송출 확인

## Phase 7: 플레이어 통합

### 7.1 HLS.js 웹 플레이어

```html
<!DOCTYPE html>
<html>
<head>
  <title>Live Stream Player</title>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
</head>
<body>
  <video id="video" controls width="1280" height="720"></video>
  
  <script>
    const video = document.getElementById('video');
    const src = 'https://your-cloudfront-domain.cloudfront.net/out/v1/endpoint-id/index.m3u8';
    
    if (Hls.isSupported()) {
      const hls = new Hls({
        debug: false,
        enableWorker: true,
        lowLatencyMode: true,
        backBufferLength: 90
      });
      
      hls.loadSource(src);
      hls.attachMedia(video);
      
      hls.on(Hls.Events.MANIFEST_PARSED, function() {
        video.play();
      });
      
      hls.on(Hls.Events.ERROR, function(event, data) {
        console.error('HLS Error:', data);
      });
    }
    else if (video.canPlayType('application/vnd.apple.mpegurl')) {
      video.src = src;
      video.addEventListener('loadedmetadata', function() {
        video.play();
      });
    }
  </script>
</body>
</html>
```

### 7.2 Video.js 플레이어

```html
<!DOCTYPE html>
<html>
<head>
  <title>Live Stream - Video.js</title>
  <link href="https://vjs.zencdn.net/8.5.2/video-js.css" rel="stylesheet">
  <script src="https://vjs.zencdn.net/8.5.2/video.min.js"></script>
</head>
<body>
  <video id="live-stream" class="video-js vjs-default-skin" controls width="1280" height="720">
    <source src="https://your-cloudfront-domain.cloudfront.net/out/v1/endpoint-id/index.m3u8" type="application/x-mpegURL">
  </video>
  
  <script>
    const player = videojs('live-stream', {
      liveui: true,
      fluid: true,
      responsive: true
    });
  </script>
</body>
</html>
```

## Phase 8: 모니터링 설정

### 8.1 CloudWatch Alarms

MediaLive 알람:
- Input Video Frame Rate < 25 fps
- Output Dropped Frames > 10
- Active Alerts > 0

MediaPackage 알람:
- Egress Request Count (spike 감지)
- Origin Request Count
- 4xx/5xx Error Rate

CloudFront 알람:
- 5xx Error Rate > 1%
- Cache Hit Rate < 80%

### 8.2 대시보드 생성

CloudWatch Dashboard에 추가할 메트릭:
- MediaLive Input/Output 상태
- 비트레이트 그래프
- CloudFront 요청 수
- S3 저장 용량

## Phase 9: 보안 강화

### 9.1 RTMP Input Security

MediaLive Input Security Group에 IP 제한:
- 모바일 네트워크 IP 대역
- 사무실 고정 IP
- VPN IP 범위

### 9.2 CloudFront Signed URLs (옵션)

Lambda@Edge 함수로 토큰 기반 인증:
- JWT 검증
- 시간 제한 URL
- 사용자별 접근 제어

### 9.3 S3 Encryption

Archive Bucket 설정:
- SSE-S3 또는 SSE-KMS
- Bucket Versioning
- Access Logging

## Phase 10: 비용 관리

### 10.1 자동 시작/중지

Lambda 함수로 스케줄링:
```python
import boto3

def lambda_handler(event, context):
    medialive = boto3.client('medialive')
    channel_id = 'your-channel-id'
    
    action = event.get('action')  # 'start' or 'stop'
    
    if action == 'start':
        medialive.start_channel(ChannelId=channel_id)
    elif action == 'stop':
        medialive.stop_channel(ChannelId=channel_id)
    
    return {'statusCode': 200, 'body': f'Channel {action}ed'}
```

EventBridge Rule:
- 스트리밍 시작 시간: cron(0 19 * * ? *)
- 스트리밍 종료 시간: cron(0 23 * * ? *)

### 10.2 비용 모니터링

Cost Explorer에서 추적:
- MediaLive Encoding Hours
- MediaPackage Egress GB
- CloudFront Data Transfer GB
- S3 Storage GB

Budget Alert 설정:
- 월 예산: $100
- 알림: 80% 도달 시

## 트러블슈팅 가이드

### 문제 1: 스트림이 연결되지 않음

확인 사항:
1. MediaLive 채널이 Running 상태인지
2. RTMP URL과 Stream Key가 정확한지
3. Input Security Group에 IP가 허용되어 있는지
4. Larix Broadcaster 비디오/오디오 권한

### 문제 2: 플레이어에서 재생 안 됨

확인 사항:
1. CloudFront URL이 정확한지
2. CORS 헤더가 설정되어 있는지
3. MediaPackage Endpoint가 활성화되어 있는지
4. 브라우저 콘솔에서 네트워크 에러 확인

### 문제 3: 버퍼링이 심함

최적화:
1. MediaLive Encoder 비트레이트 조정
2. ABR 레더 추가
3. CloudFront Cache 설정 최적화
4. MediaPackage Segment Duration 조정

### 문제 4: 지연시간이 큼

개선 방법:
1. MediaPackage Time Delay 감소
2. Segment Duration을 2-4초로 축소
3. Low Latency HLS 프로필 사용
4. CloudFront Price Class 최적화
